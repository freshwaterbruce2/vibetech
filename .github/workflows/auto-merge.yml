name: Auto Merge PRs

on:
    pull_request:
        types: [opened, synchronize, reopened, labeled]
    pull_request_review:
        types: [submitted]
    check_suite:
        types: [completed]
    workflow_run:
        workflows: ["CI"]
        types: [completed]

permissions:
    contents: write
    pull-requests: write

jobs:
    auto-merge:
        runs-on: ubuntu-latest
        # Only run for PRs from the repo owner or with 'auto-merge' label
        if: |
            github.event.pull_request.user.login == github.repository_owner ||
            contains(github.event.pull_request.labels.*.name, 'auto-merge')

        steps:
            - name: Check out repository
              uses: actions/checkout@v4

            - name: Enable auto-merge for Dependabot PRs
              if: github.actor == 'dependabot[bot]'
              run: gh pr merge --auto --squash "$PR_URL"
              env:
                  PR_URL: ${{ github.event.pull_request.html_url }}
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Auto-merge owner PRs (after checks pass)
              if: |
                  github.event.pull_request.user.login == github.repository_owner &&
                  github.event.pull_request.mergeable_state == 'clean'
              run: |
                  echo "Enabling auto-merge for PR #${{ github.event.pull_request.number }}"
                  gh pr merge --auto --squash "$PR_URL" --delete-branch
              env:
                  PR_URL: ${{ github.event.pull_request.html_url }}
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Auto-merge labeled PRs
              if: contains(github.event.pull_request.labels.*.name, 'auto-merge')
              run: |
                  echo "Auto-merging PR with 'auto-merge' label"
                  gh pr merge --auto --squash "$PR_URL" --delete-branch
              env:
                  PR_URL: ${{ github.event.pull_request.html_url }}
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # Separate job for auto-approving (requires PAT with repo scope for self-approval)
    auto-approve:
        runs-on: ubuntu-latest
        if: |
            github.event.pull_request.user.login == github.repository_owner ||
            github.actor == 'dependabot[bot]'

        steps:
            - name: Auto-approve PR
              uses: hmarr/auto-approve-action@v4
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
