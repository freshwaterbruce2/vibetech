#!/bin/sh
# Pre-commit hook - Checks modified apps only (fast & targeted)
# Strategy: Run checks only for modified apps to keep commits fast

echo "üîç Running pre-commit checks on modified files..."

# Get list of modified apps
MODIFIED_APPS=$(git diff --cached --name-only | grep -E '^apps/' | cut -d'/' -f1-2 | sort -u)

if [ -z "$MODIFIED_APPS" ]; then
  echo "‚úì No apps modified, skipping checks"
  exit 0
fi

HAS_ERRORS=0

# Check each modified app
for APP_PATH in $MODIFIED_APPS; do
  APP_NAME=$(basename "$APP_PATH")
  echo ""
  echo "üì¶ Checking: $APP_NAME"

  # Check if app has package.json
  if [ ! -f "$APP_PATH/package.json" ]; then
    continue
  fi

  # Run typecheck if available
  if grep -q '"typecheck"' "$APP_PATH/package.json"; then
    echo "  üìò TypeScript check..."
    if ! (cd "$APP_PATH" && pnpm typecheck 2>&1 | head -n 20); then
      echo "  ‚ùå TypeScript errors in $APP_NAME"
      HAS_ERRORS=1
    fi
  fi

  # Run lint if available (warnings OK, errors fail)
  if grep -q '"lint"' "$APP_PATH/package.json"; then
    echo "  üîß ESLint check..."
    if ! (cd "$APP_PATH" && pnpm lint 2>&1 | grep -E '(error|‚úñ)' | head -n 10); then
      # No output = no errors, or warnings only (OK)
      :
    else
      echo "  ‚ö†Ô∏è  Lint issues in $APP_NAME (check manually)"
    fi
  fi
done

if [ $HAS_ERRORS -eq 1 ]; then
  echo ""
  echo "‚ùå Pre-commit checks FAILED"
  echo "   Fix TypeScript errors before committing"
  echo "   Run: pnpm --filter <app-name> typecheck"
  exit 1
fi

echo ""
echo "‚úÖ Pre-commit checks passed!"
exit 0
